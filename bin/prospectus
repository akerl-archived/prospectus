#!/usr/bin/env ruby

require 'prospectus'
require 'mercenary'

def run_file(params, file)
  Prospectus.load_from_file({ file: file }.merge(params)).check
rescue RuntimeError
  puts "Failed parsing #{Dir.pwd}/#{file}"
  raise
end

def load_list(params)
  return run_file(params, '.prospectus') if File.exist? '.prospectus'
  fail('No .prospectus/.prospectus.d found') unless Dir.exist? '.prospectus.d'
  files = Dir.glob('.prospectus.d/*')
  fail('No files in .prospectus.d') if files.empty?
  files.map { |x| run_file(params, x) }.flatten
end

Mercenary.program(:prospectus) do |p|
  p.version Prospectus::VERSION
  p.description 'Tool and DSL for checking expected vs actual state'
  p.syntax 'prospectus [options]'

  # rubocop:disable Metrics/LineLength
  p.option :directory, '-d DIR', '--directory DIR', 'Change to directory before loading'
  p.option :good_only, '-g', '--good', 'Show only items with good state'
  p.option :all, '-a', '--all', 'Show all items'
  p.option :json, '-j', '--json', 'Output results as json'
  # rubocop:enable Metrics/LineLength

  p.action do |_, options|
    options[:directory] ||= '.'
    Dir.chdir(options[:directory]) do
      results = load_list(options)
      if options[:json]
        puts results.to_json
      else
        results.each { |x| puts "#{x.name}: #{x.actual} / #{x.expected}" }
      end
    end
  end
end
